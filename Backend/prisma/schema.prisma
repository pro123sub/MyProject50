generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// MODELS
// ==============================

model User {
  id                  Int                   @id @default(autoincrement())
  customUserId        String?               @unique
  name                String?
  email               String?               @unique
  phone               String                @unique
  password            String?
  phoneVerified       Boolean               @default(false)
  phoneVerifiedAt     DateTime?
  dob                 DateTime?
  gender              Gender?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  role                UserRole              @default(CUSTOMER)
  verificationStatus  VerificationStatus    @default(PENDING)

  // One-to-One Relations
  aadhaarVerification AadhaarVerification?
  panVerification     PanVerification?
  employment          EmploymentDetail?
  address             AddressDetail?

  // OTP History
  otps                OtpVerification[]

  // Loan History
  loans               Loan[]

  // Loan Applications
  loanApplications    LoanApplication[]

  // ✅ KYC Relations
  documents           UserDocument[]
  locations           UserLocation[]
  status              UserDocumentStatus?
}

model AadhaarVerification {
  id            Int      @id @default(autoincrement())
  aadhaarNumber String   @unique
  verified      Boolean  @default(false)
  verifiedAt    DateTime?
  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id])
}

model PanVerification {
  id          Int      @id @default(autoincrement())
  panNumber   String   @unique
  verified    Boolean  @default(false)
  verifiedAt  DateTime?
  userId      Int      @unique
  user        User     @relation(fields: [userId], references: [id])
}

model EmploymentDetail {
  id             Int                @id @default(autoincrement())
  userId         Int                @unique
  user           User               @relation(fields: [userId], references: [id])
  
  employmentType EmploymentType
  employerName   String?
  companyAddress String?
  monthlyIncome  Float?
  stability      JobStability?

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  loanApplications LoanApplication[] @relation("EmploymentLoanApplications")
}

model AddressDetail {
  id                   Int         @id @default(autoincrement())
  currentAddress       String?
  permanentAddress     String?
  city                 String?
  state                String?
  postalCode           String?
  currentAddressType   AddressType?
  currentAddressProof  String?
  userId               Int         @unique
  user                 User        @relation(fields: [userId], references: [id])
}

model OtpVerification {
  id        Int       @id @default(autoincrement())
  otpCode   String
  expiresAt DateTime
  verified  Boolean   @default(false)
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
}

model Loan {
  id            Int       @id @default(autoincrement())
  loanAmount    Float
  purposeOfLoan String?
  interestRate  Float?
  termMonths    Int?
  startDate     DateTime?
  status        LoanStatus @default(PENDING)
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model LoanApplication {
  id                 Int                  @id @default(autoincrement())
  userId             Int
  user               User                 @relation(fields: [userId], references: [id])

  employmentDetailId Int?
  employmentDetail   EmploymentDetail?    @relation("EmploymentLoanApplications", fields: [employmentDetailId], references: [id])

  loanType           LoanType
  loanAmount         Float?
  otpVerified        Boolean   @default(false)
  status             LoanStatus @default(PENDING)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// ✅ New Model - Supabase Document Storage
model UserDocument {
  id          Int            @id @default(autoincrement())
  userId      Int
  user        User           @relation(fields: [userId], references: [id])

  docType     DocumentType
  filePath    String         // Supabase storage path (not full URL)
  fileUrl     String?
  fileName    String?
  mimeType    String?
  size        Int?
  checksum    String?        // sha256 checksum
  status      DocumentUploadStatus @default(SUBMITTED)
  verified    Boolean        @default(false)
  verifiedBy  Int?
  verifiedAt  DateTime?
  notes       String?
  uploadedAt  DateTime       @default(now())

  @@index([userId, docType])
}

// ✅ New Model - Location Capture
model UserLocation {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])

  latitude    Float
  longitude   Float
  accuracy    Float?

  locality    String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  placeName   String?

  capturedAt  DateTime @default(now())
}
// ✅ New Model - Document Submission Status
model UserDocumentStatus {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  status      String   @default("PENDING_UPLOAD") // PENDING_UPLOAD | SUBMITTED | VERIFIED | REJECTED
  latitude    Float?
  longitude   Float?
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}


// ==============================
// ENUMS
// ==============================

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum UserRole {
  CUSTOMER
  DSA
  AFFILIATE
  ADMIN
  SUPER_ADMIN
}

enum Gender {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
}

enum JobStability {
  VERY_UNSTABLE
  SOMEWHAT_UNSTABLE
  NEUTRAL
  STABLE
  VERY_STABLE
}

enum AddressType {
  OWNER
  RENTED
  RESIDENTIAL
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  CLOSED
}

enum EmploymentType {
  SALARIED
  SELF_EMPLOYED
  STUDENT
  UNEMPLOYED
  OTHER
}

enum LoanType {
  PERSONAL
  HOME
  EDUCATION
  BUSINESS
  AUTO
  CREDIT_CARD
  OTHER
}

// ✅ New Enum - All possible document types
enum DocumentType {
  AADHAAR
  PAN
  PAY_SLIP
  BANK_STATEMENT
  PHOTO
  SIGNATURE
}
// New Enum 
enum DocumentUploadStatus {
  PENDING_UPLOAD
  SUBMITTED
  VERIFIED
  REJECTED
}


